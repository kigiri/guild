const {
  clientID,
  clientSecret,
  domain,
  guild,
  bnetPath,
  failureRedirect,
  successRedirect,
} = require('./config')

const passport = require('passport')
const express = require('express')
const session = require('express-session')
const FileStore = require('session-file-store')(session)
const BnetStrategy = require('passport-bnet').Strategy
const zlib = require('zlib')


const wesh = _ => (console.log(_), _)

const callbackPath = `${bnetPath}callback`
const callbackURL = `https://${domain}${callbackPath}`
const defaultHtml = `<!DOCTYPE html><html><head><meta charset="utf-8"><link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAACEFBMVEUNEzAVHD0RFzMNECALEiYXHkEXHkQSGToVHjsJDycIDyENFTcTFytQNAkTFCQNEDc4LjIHCxURFzAVHkUYIEgOFioWGR0iKk44MjY8KQpwUyc7LAkmFQUbIDqvfTdVPQwYBAEyHxlTFwILDzRdRBmAYyG7qlhkQxGkdysgHBE1EAM4GAaRZCFQOBSwfC5KGQahcCQ1FwXd02ydaSVRGALSu3SjjjWpgTeoeS/PozvCjzoMDhsODhYMFSkVGjZ3azwZHyZMOio1Lix8MAkYIUAWHTYjKUoeKUoaJE8lIBorGBwQHEUcGCYXIkh9KQoeHiZnThQgGQgMCAA0IxNUMQVUPRZ2URoSGD0PGUMKDi4wFAGkiDB8YSZ7TRSZaB9ePhwSDwJiGASRfDSldChnIwxLLhOUbCAiFxWwiDhxSRoRFDEdFQWgfjNvSiiQbidUHgplTyVtSBNiZz6IXxu/oEOQgj+QbzxTV0aCjGgpEQVmRQ9sYS44Ni+ldi2SaSkWGCiNZCFeOw06IxB7WBaPdSxaUTbX0W+VZh4zHwo8NB7XzXtgOxRPIQe+lzLZ3nq6rUg/GwWqh0uGZyZDJgvEkzOZcB+fezWMZi7ay23bzHKJbStQGAvMoUKUciLZ0VzLrUWDUBSrgzvKqEWSbCuth0G0mDnVzk1+Xi+PWhyxhz/TuFulgUfVtUlqKQ+GcyTCoFDhpZ6bAAABEUlEQVR4XgUAA3LEAHCTnG3btkvbtm3btm0bX+yAiEImV2iZTC0AkCkUEWAc4tg0kza1vDE3PtIJGGAounL7eLq/vblr6KChfGjsDly+PkfODlY9tgV92yD079z8fodDD+eeNe/6vKkX1OH3wFvw4+/zxLu12NquBOz4/sVtf4rcKYzWnqFhGYCZ7nD6vq5DS5a+0QG9GahUhuTq58I1a3M1t0gZRKCWyw+P/EHTRFNtTXVRDgGIWWVde/4Zi8/tMBST0gmA8LgM3aRV06CqossQHh5QLkHtrBfXaYwlhbmZySSIiY1Pyi7QqSrtSgFNkYCDKH6cBE8S55fS84RpiQI2sKJxHASPZEjlwtQUHJv1DwGnQ1YYKo6rAAAAAElFTkSuQmCC"/><title>&lt;Marque repère&gt;</title><style>html { background-color: #475c72; background-image: linear-gradient(#43576d 2px, transparent 2px), linear-gradient(90deg, #43576d 2px, transparent 2px), linear-gradient(#43576d 1px, transparent 1px), linear-gradient(90deg, #43576d 1px, transparent 1px); background-size:100px 100px, 100px 100px, 20px 20px, 20px 20px; background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px }body { text-align: center; font-family: "Blizzard","Arial","Helvetica","Segoe UI Symbol","Segoe MDL2 Assets",sans-serif; font-size: 15px; line-height: 20px }#login { color: grey; background: #1e2327; padding: 40px 0; width: 480px; vertical-align: center; border-radius: 4px; border: 1px solid #10181e; margin: 160px auto }#sep { height: 2px; width: 80%; background-color: #273745; margin: 12px auto }button:hover { background-image: linear-gradient(to bottom,#37c0ff,#0097dd); background-color: #21b0f1; border-color: transparent; box-shadow: 0 0 rgba(0,0,0,0) }button:active { background-image: linear-gradient(to bottom,#006ea1,#00608d); box-shadow: 1px 1px 2px rgba(0,0,0,0.6) inset, 0 0 0 1px rgba(255,255,255,0.07) inset; background-color: #006899; color: rgba(255,255,255,0.7); border-color: transparent; padding: 10px 29px 8px 31px}h1 { font-weight: normal; color: #19f519}button { outline: 0; background-color: #098cc8; background-image: linear-gradient(to bottom,#0f9ada,#0076ad); border-radius: 2px; border: 0; box-shadow: 0 1px 1px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.15) inset; color: #fff; font-size: 17px; height: 40px; line-height: 20px; margin-bottom: 6px; margin-top: 5px; overflow: hidden; padding: 9px 30px; text-overflow: ellipsis; white-space: nowrap;}</style></head><body><div id="login"><h1>&lt;${guild}&gt;</h1><p>Guilde PvP de qualité sur Archimonde</p><div id="sep"></div><img src="data:image/png;base64,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"/><br><button onclick="window.location.href='${callbackPath}'">Ce connecter avec votre compte battle.net</button></div></body></html>`
const zDefaultHtml = zlib.gzipSync(defaultHtml, {
  level: zlib.Z_BEST_COMPRESSION,
})
const zHtmlLen = Buffer.byteLength(zDefaultHtml)

const app = express()

app.use(session({
  store: new FileStore({ encrypt: false }),
  resave: false,
  saveUninitialized: true,
  secret: 'waliyaan is a pyronmane',
}))

app.use(passport.initialize())
app.use(passport.session())

const passUser = (user, done) => done(null, user)

passport.serializeUser(passUser)
passport.deserializeUser(passUser)

passport.use(new BnetStrategy({ clientID, clientSecret, callbackURL, scope: 'wow.profile' },
  (accessToken, refreshToken, profile, done) => done(null, profile)))

app.get(bnetPath, passport.authenticate('bnet'))
app.get(callbackPath, passport.authenticate('bnet', { failureRedirect }),
  (req, res) => res.redirect(successRedirect))

app.get('/', function(req, res) {
  if (req.isAuthenticated()) {
    var output = '<h1>Yoooo le site est en cour</h1>'+ req.user.id +'<br>'
    if (req.user.battletag) {
      output += req.user.battletag +'<br>'
    }
    output += '<a href="/logout">Logout</a>'
    res.send(output)
  } else {
    if (/req accept gzip/) {
      res.set({
        'Content-Length': zHtmlLen,
        'Content-Type': 'text/html',
        'Content-Encoding': 'gzip',
      })
      res.send(zDefaultHtml)
    } else {
      res.send(defaultHtml)
    }
  }
})

app.get('/logout', function(req, res) {
  req.logout()
  res.redirect('/')
})

app.listen(3548, () => console.log('Server up, listening to 3548'))


